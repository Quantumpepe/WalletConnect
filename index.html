
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WalletConnect V2 Beispiel</title>
  <!-- Einbindung des WalletConnect V2 Sign-Client über CDN -->
  <script src="https://unpkg.com/@walletconnect/sign-client@1.8.0/dist/umd/index.min.js"></script>
</head>
<body>
  <!-- Dropdown für die Netzwerkauswahl -->
  <label for="chainSelect">Wähle dein Netzwerk:</label>
  <select id="chainSelect">
      <!-- Beachte: In V2 werden Chains im Format "namespace:chainId" angegeben -->
      <option value="eip155:1">ETH (Ethereum Mainnet)</option>
      <option value="eip155:56">BNB (Binance Smart Chain)</option>
      <option value="eip155:137">POL (Polygon Mainnet)</option>
  </select>

  <!-- Button zum Starten des Verbindungsvorgangs -->
  <button id="connectButton">WalletConnect verbinden</button>

  <script>
    // Hole die DOM-Elemente
    const connectButton = document.getElementById('connectButton');
    const chainSelect = document.getElementById('chainSelect');

    let signClient;  // Referenz auf den Sign Client

    // Asynchrone Initialisierungsfunktion für WalletConnect V2
    async function initWalletConnect() {
      // Überprüfe, ob der globale Name vorhanden ist
      if (!window.SignClient) {
        console.error("SignClient ist nicht verfügbar. Bitte prüfe, ob das Skript korrekt geladen wurde.");
        return;
      }
      
      try {
        // Initialisiere den Sign Client mit der korrekten Referenz (window.SignClient)
        signClient = await window.SignClient.init({
          projectId: "67c4292e272ac36fdbc049335adf6b67", // Ersetze diesen Wert durch deine tatsächliche Projekt-ID
          relayUrl: "wss://relay.walletconnect.com",        // Standard Relay URL
          metadata: {
            name: "My DApp",
            description: "DApp Beispiel mit WalletConnect V2",
            url: "https://your-dapp-url.com",
            icons: ["https://your-dapp-url.com/icon.png"]
          }
        });
        console.log("WalletConnect V2 Sign Client initialisiert");
      } catch (error) {
        console.error("Fehler bei der Initialisierung des Sign Clients:", error);
      }
    }

    // Funktion zum Verbindungsaufbau
    async function connectWallet() {
      // Initialisiere den Client, falls noch nicht geschehen
      if (!signClient) {
        await initWalletConnect();
      }

      // Lese die ausgewählte Chain aus dem Dropdown aus (z.B. "eip155:1")
      const selectedChain = chainSelect.value;
      console.log("Ausgewählte Chain:", selectedChain);

      // Definiere das erforderliche Namespace-Objekt
      const namespaces = {
        eip155: {
          methods: ["eth_sendTransaction", "personal_sign", "eth_signTypedData"],
          chains: [selectedChain],
          events: ["chainChanged", "accountsChanged"]
        }
      };

      try {
        // Erzeuge eine Verbindungsanfrage: es wird ein URI und eine approval-Funktion zurückgegeben
        const { uri, approval } = await signClient.connect({
          requiredNamespaces: namespaces
        });

        // Falls ein URI erzeugt wurde, gebe diesen in der Konsole aus oder verwende ihn in einem QR-Code-Modul
        if (uri) {
          console.log("WalletConnect URI:", uri);
          // Beispiel: Falls du ein QR-Code-Modal integrieren möchtest, kannst du es hier öffnen.
          // QRCodeModal.open(uri, () => { console.log("QR Code geschlossen") });
        }

        // Warte auf die Bestätigung des Wallet-Nutzers (über Scannen und Akzeptieren in der Wallet-App)
        const session = await approval();
        console.log("Verbindung erfolgreich hergestellt. Session:", session);
      } catch (error) {
        console.error("Fehler während der Verbindung:", error);
      }
    }

    // Event-Listener für den Button, um die Verbindung zu initiieren
    connectButton.addEventListener('click', async () => {
      await connectWallet();
    });
  </script>
</body>
</html>
