
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WalletConnect V2 Beispiel</title>
  <!-- Einbindung des WalletConnect V2 Sign-Client über CDN -->
  <script src="https://unpkg.com/@walletconnect/sign-client@1.8.0/dist/umd/index.min.js"></script>
</head>
<body>
  <!-- Dropdown für die Netzwerkauswahl -->
  <label for="chainSelect">Wähle dein Netzwerk:</label>
  <select id="chainSelect">
      <!-- Beachte: In V2 werden Chains im Format "namespace:chainId" angegeben -->
      <option value="eip155:1">ETH (Ethereum Mainnet)</option>
      <option value="eip155:56">BNB (Binance Smart Chain)</option>
      <option value="eip155:137">POL (Polygon Mainnet)</option>
  </select>

  <!-- Button zum Starten des Verbindungsvorgangs -->
  <button id="connectButton">WalletConnect verbinden</button>

  <script>
    // Hole die DOM-Elemente
    const connectButton = document.getElementById('connectButton');
    const chainSelect = document.getElementById('chainSelect');

    let signClient;  // Referenz auf den Sign Client

    // Asynchrone Initialisierungsfunktion für WalletConnect V2
    async function initWalletConnect() {
      // Der Sign Client wird initialisiert.
      // Ersetze "67c4292e272ac36fdbc049335adf6b67" mit deiner tatsächlichen Projekt-ID.
      signClient = await WalletConnectSignClient.init({
        projectId: "67c4292e272ac36fdbc049335adf6b67",      // Erforderlich für V2 – besorge dir diesen Schlüssel über WalletConnect
        relayUrl: "wss://relay.walletconnect.com", // Standard Relay URL
        metadata: {
          name: "My DApp",
          description: "DApp Beispiel mit WalletConnect V2",
          url: "https://your-dapp-url.com",
          icons: ["https://your-dapp-url.com/icon.png"]
        }
      });
      console.log("WalletConnect V2 Sign Client initialisiert");
    }

    // Funktion zum Verbindungsaufbau
    async function connectWallet() {
      // Initialisiere den Client, falls noch nicht geschehen
      if (!signClient) {
        await initWalletConnect();
      }

      // Lese die ausgewählte Chain aus dem Dropdown aus.
      // Beispielwerte: "eip155:1", "eip155:56", "eip155:137"
      const selectedChain = chainSelect.value;
      console.log("Ausgewählte Chain:", selectedChain);

      // Definiere das erforderliche Namespace-Objekt.
      // Hier legen wir fest, welche Methoden und Events im jeweiligen Namespace genutzt werden sollen.
      const namespaces = {
        eip155: {
          methods: ["eth_sendTransaction", "personal_sign", "eth_signTypedData"],
          chains: [selectedChain],
          events: ["chainChanged", "accountsChanged"]
        }
      };

      try {
        // Erzeuge eine Verbindungsanfrage. Dabei liefert die Funktion ein Objekt mit dem URI und
        // einer "approval"-Methode, die auf die Bestätigung des Wallet-Nutzers wartet.
        const { uri, approval } = await signClient.connect({
          requiredNamespaces: namespaces
        });

        // Wenn ein URI erzeugt wurde, kann dieser als Grundlage für einen QR-Code genutzt werden.
        // Hier geben wir den URI der Vereinfachung halber in der Konsole aus.
        if (uri) {
          console.log("WalletConnect URI:", uri);
          // Beispiel: Hier könnte man ein externes QR-Code-Modal öffnen:
          // QRCodeModal.open(uri, () => { console.log("QR Code geschlossen") });
        }

        // Warte auf die Benutzergenehmigung (Scannen und Akzeptieren in der Wallet-App).
        const session = await approval();
        console.log("Verbindung erfolgreich hergestellt. Session:", session);

        // Optional: Hier kannst du weitere Aktionen ausführen, z.B. die Accounts und die Chain-ID auslesen.
        // session.namespaces.eip155.accounts enthält in etwa Werte wie "eip155:1:0x..."
      } catch (error) {
        console.error("Fehler während der Verbindung:", error);
      }
    }

    // Event-Listener für den Button, um die Verbindung zu initiieren.
    connectButton.addEventListener('click', async () => {
      await connectWallet();
    });
  </script>
</body>
</html>

